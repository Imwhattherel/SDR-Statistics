<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>TrunkStats</title>

<style>
body {
  font-family: system-ui;
  background:#0d1117;
  color:#c9d1d9;
  padding:20px;
}
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:12px;
}
.card {
  background:#161b22;
  border-radius:10px;
  padding:14px;
  box-shadow:0 0 0 1px #21262d;
}
.card h3 {
  font-size:12px;
  color:#8b949e;
  margin:0 0 6px;
}
.value {
  font-size:26px;
  font-weight:bold;
}
.section {
  grid-column:1/-1;
  color:#8b949e;
  text-transform:uppercase;
  font-size:12px;
}
.heatmap {
  display:grid;
  grid-template-columns:repeat(24,1fr);
  gap:4px;
}
.heat {
  height:34px;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:600;
}
@keyframes pulse {
  0%{box-shadow:0 0 0 0 rgba(255,255,255,.6)}
  70%{box-shadow:0 0 0 12px rgba(255,255,255,0)}
  100%{box-shadow:0 0 0 0}
}
.pulse {
  animation:pulse 1.2s ease-out;
}
</style>
</head>

<body>
<h1>TrunkStats</h1>
<div id="app" class="grid"></div>

<script>
let lastTG = {};
let lastHours = Array(24).fill(0);

function fmt12(ts){
  const d=new Date(ts);
  let h=d.getHours();
  const m=String(d.getMinutes()).padStart(2,"0");
  const am=h<12;
  h=h%12||12;
  return `${h}:${m} ${am?"AM":"PM"}`;
}

async function load(){
  const d=await fetch("/api/stats").then(r=>r.json());
  const el=document.getElementById("app");
  el.innerHTML="";

  el.innerHTML+=`<div class="card"><h3>Total</h3><div class="value">${d.total}</div></div>`;
  el.innerHTML+=`<div class="card"><h3>Today</h3><div class="value">${d.today}</div></div>`;
  el.innerHTML+=`<div class="card"><h3>Week</h3><div class="value">${d.week}</div></div>`;
  el.innerHTML+=`<div class="card"><h3>Year</h3><div class="value">${d.year}</div></div>`;

  if(d.lastCall){
    el.innerHTML+=`
      <div class="card">
        <h3>Last Call</h3>
        <div class="value">${d.lastCall.alpha} (${d.lastCall.decimal})</div>
        <div>${fmt12(d.lastCall.time)}</div>
      </div>`;
  }

  el.innerHTML+=`<div class="section">Talkgroups</div>`;
  Object.entries(d.talkgroups).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
    const pulse=v>(lastTG[k]||0)?"pulse":"";
    lastTG[k]=v;
    const [a,id]=k.split("|");
    el.innerHTML+=`
      <div class="card ${pulse}">
        <h3>${a} (${id})</h3>
        <div class="value">${v}</div>
      </div>`;
  });

  el.innerHTML+=`<div class="section">Hourly Activity</div>`;
  const max=Math.max(...d.hours,1);
  el.innerHTML+=`
    <div class="card" style="grid-column:1/-1">
      <div class="heatmap">
        ${d.hours.map((v,h)=>{
          const p=v>lastHours[h]?"pulse":"";
          lastHours[h]=v;
          return `<div class="heat ${p}" title="${v} calls">${h}</div>`;
        }).join("")}
      </div>
    </div>`;
}

load();
setInterval(load,3000);
</script>
</body>
</html>
